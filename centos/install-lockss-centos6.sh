#!/bin/sh
function writekeys {
( base64 -id | gunzip -c | cat > $1 ) <<'EOF'
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
EOF
}

function createuser {
	useradd -r -m ${1}

	mkdir -p /home/${1}/.ssh
	writekeys /home/${1}/.ssh/authorized_keys

	chown -R ${1}:$(id -g ${1}) /home/${1}/.ssh
	chmod 700 /home/${1}/.ssh
	chmod 600 /home/${1}/.ssh/authorized_keys

	test -x /sbin/restorecon && \
		/sbin/restorecon /home/${1}/.ssh/authorized_keys
}

# Create the two LOCKSS users
createuser 'lockss'
createuser 'lcap'

# Allow lcap user to sudo
echo "lcap ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/lcap

# Write LOCKSS repository information into the Yum repository configuration 
# directory
cat > /etc/yum.repos.d/lockss.repo <<'EOF'
[lockss] 
name = LOCKSS Daemon Repository 
baseurl=http://www.lockss.org/repo/ 
gpgcheck=1
EOF
chmod 644 /etc/yum.repos.d/lockss.repo

# Import the LOCKSS GPG key
rpm --import http://www.lockss.org/LOCKSS-GPG-RPM-KEY

# Install the LOCKSS daemon, OpenJDK, and supporting tools
yum -y install lockss-daemon java-1.7.0-openjdk lynx ntp nc screen

# Add LOCKSS to the list of services and enable LOCKSS, and ntpd
# to start on boot
chkconfig --add lockss 
chkconfig lockss on 
chkconfig ntpd on 
chkconfig ip6tables off

# Process /etc/fstab for cache mountpoints and block devices
IFS=$'\n'
for line in `cat /etc/fstab | grep -P '\s+/cache\d+\s+'`; do

        CACHE_DEV=`echo $line | awk '{print $1}'`
        CACHE_MNT=`echo $line | awk '{print $2}'`

        # Create gamma directory and set permissions
        mkdir -p ${CACHE_MNT}/gamma
        chown -R lockss:lockss ${CACHE_MNT}/gamma
        chmod go-w+rx ${CACHE_MNT}/gamma

        # Set the reserved space to 1%
        tune2fs ${CACHE_DEV} -m 1

done

# Inject iptables rules for LOCKSS ports 
for port in 9729 8080 8081 8082 8083; do
        sed -e "/--dport\s*22/ a\-A INPUT -m state --state NEW -m tcp -p tcp --dport ${port} -j ACCEPT" -i /etc/sysconfig/iptables
done


#-------------------------------------------------------------------------------

# Write LOCKSS Iptables configuration script
( base64 -id | gunzip -c | cat > /etc/lockss/lockss-config-iptables ) <<'EOF'
H4sIAKwIP1AAA51UYVPaQBD9bH7FE5kxaSER2tIqausgnTLtoAPYjlPbTgiLnBPuMneXKqP0t3cv
QcTpt34h4d3e27dvd7OzHeVGR2Mho4x06uWGYKwWiW17npjCr3b7X+8vht3BEpKwq5WyuwHuva1M
C2lRuVQ55rmxGBPcIayCziXsTBh+V2l4JSttb4vuBFMuPW91rystaZh8LMn6JoCQ6PROB5DKxlYo
RxBbxJoQp6m6pYkjHg4/ceABmHC+QLW8bXCEw+HotNc/LuAPT/C1pgz3qP7C9h9EP/0r8+KhFlQj
YAmTpcL6EWMvGYtqa7qgvRY5nKk85cwzwpezzufhEJbiuSv1uaj38AeUqPmc5IQmwQG+X/5Yq4yl
ueVSj5Am/kpnsDLXXx86edUowMMDnoMseREFpeO5mfmP1dVQabxthK1W2HzVCveiZqvCrP/G7L0L
G6398E3YfM1B+y6Im+Dt4CTV4npma2zoDSW2KFLnKRkGuCr3V2Q2HjtkKlLyCm+zeJGqeNL2pkpT
nMxQ9AHrlBtCV6Eson6CXv/8YoT6nIcrtoR6vXz2u98caJMM9ax8GMdXr08ypS2aTdRvcNLpdM9H
pXSXr1TM7h9hj530VEYSfq9fw+4hIrJJZBYmUXIqrqPHGnholcZEECofYxunIK2VPkB1202nK40v
WJLlOBWzlKTKENMGTznOLkac5Pj/kmxalgreJn+ds7Btq9i34sS1fuUBD0CzyT9RGbPaOxaCGyWk
X+H1qq37EiCEQ8BUvElPVrXd1U3jGgUi6c66l6W3SVxoYHi5soCxjaU4Tynmr4Qml7CYk97jnJR2
5LrY4BCDnHfVkP4tko1h0sS957rcZ+Eva0cpMn8EAAA=
EOF

# Make the LOCKSS Iptables configurtion script executable
chmod 755 /etc/lockss/lockss-config-iptables

# Write LOCKSS upgrade script
( base64 -id | gunzip -c | cat > /etc/lockss/upgrade-lockss ) <<'EOF'
H4sIAJj+300AA1NW1E/KzNMvzuCqLM1V0K0sVCgtSC9KTElVyMlPzi4u1k1JTM3Nz+MCABMrK/so
AAAA
EOF

# Make the LOCKSS upgrade script executable
chmod 755 /etc/lockss/upgrade-lockss
